<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmalens - Smart Pill Identifier</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00897b;
            --primary-dark: #00695c;
            --primary-light: #4db6ac;
            --accent: #26a69a;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #dadbe2 0%, #c6c3c9 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .app-container {
            background: white;
            width: 100%;
            max-width: 900px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .logo-container {
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin: 0 auto;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .header h1 {
            color: #ffa500;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }

        .header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            position: relative;
            z-index: 1;
        }

        .content {
            padding: 30px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 12px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            color: var(--text-light);
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            border: none;
            background: transparent;
        }

        .tab-button:hover {
            background: rgba(0, 137, 123, 0.1);
            color: var(--primary);
        }

        .tab-button.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        select,
        input[type="text"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        select:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0, 137, 123, 0.1);
        }

        /* File Upload */
        .file-upload {
            border: 3px dashed var(--primary-light);
            padding: 40px 20px;
            text-align: center;
            border-radius: 16px;
            cursor: pointer;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            transition: all 0.3s ease;
            position: relative;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, #b2dfdb 0%, #80cbc4 100%);
            transform: translateY(-2px);
        }

        .file-upload i {
            font-size: 2.5rem;
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: block;
        }

        .file-upload p {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1rem;
            margin: 0;
        }

        .image-preview-container {
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .image-preview-container img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 15px;
        }

        .change-image-btn {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .change-image-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 137, 123, 0.3);
        }

        /* Button */
        .btn-identify {
            width: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-identify:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-identify:disabled {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            cursor: not-allowed;
            transform: none;
        }

        /* Loading Animation */
        #loading {
            text-align: center;
            display: none;
            margin: 25px 0;
            padding: 30px;
            background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
            border-radius: 16px;
            border: 2px solid var(--primary-light);
        }

        .loading-animation {
            position: relative;
            height: 80px;
            margin-bottom: 20px;
        }

        .pill-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
        }

        .pill {
            width: 60px;
            height: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 25px;
            position: relative;
            animation: pillScan 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
            transition: all 0.5s ease;
        }

        .pill::before {
            content: '';
            position: absolute;
            width: 2px;
            height: 100%;
            background: white;
            left: 50%;
            transform: translateX(-50%);
            transition: all 0.5s ease;
        }

        /* Pill Breaking Animation */
        .pill.breaking {
            animation: none;
        }

        .pill.breaking::before {
            width: 4px;
            background: #ffa500;
            box-shadow: 0 0 10px #ffa500;
        }

        .pill-left,
        .pill-right {
            position: absolute;
            width: 30px;
            height: 25px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 25px;
            opacity: 0;
            box-shadow: 0 4px 15px rgba(0, 137, 123, 0.4);
        }

        .pill-left {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
            left: 50%;
            transform: translateX(-100%);
        }

        .pill-right {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            right: 50%;
            transform: translateX(100%);
        }

        .pill.broken .pill-left,
        .pill.broken .pill-right {
            opacity: 1;
        }

        .pill.broken .pill-left {
            animation: slideLeft 0.8s ease-out forwards;
        }

        .pill.broken .pill-right {
            animation: slideRight 0.8s ease-out forwards;
        }

        @keyframes slideLeft {
            to {
                transform: translateX(-150%) rotate(-15deg);
                opacity: 0;
            }
        }

        @keyframes slideRight {
            to {
                transform: translateX(150%) rotate(15deg);
                opacity: 0;
            }
        }

        .scan-line {
            position: absolute;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: scanMove 2s ease-in-out infinite;
            box-shadow: 0 0 10px var(--accent);
        }

        .scan-particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            opacity: 0;
            animation: particleFloat 2s ease-in-out infinite;
        }

        .particle:nth-child(1) {
            left: 20%;
            animation-delay: 0s;
        }

        .particle:nth-child(2) {
            left: 40%;
            animation-delay: 0.3s;
        }

        .particle:nth-child(3) {
            left: 60%;
            animation-delay: 0.6s;
        }

        .particle:nth-child(4) {
            left: 80%;
            animation-delay: 0.9s;
        }

        @keyframes pillScan {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-10px) scale(1.05);
            }
        }

        @keyframes scanMove {

            0%,
            100% {
                transform: translate(-50%, -50%) scaleX(0.5);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scaleX(1.5);
                opacity: 1;
            }
        }

        @keyframes particleFloat {
            0% {
                bottom: 0;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                bottom: 80px;
                opacity: 0;
            }
        }

        .loading-status {
            color: var(--primary-dark);
            font-weight: 600;
            font-size: 1rem;
            margin-top: 10px;
            min-height: 24px;
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: rgba(0, 137, 123, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 137, 123, 0.5);
        }

        .loading-substatus {
            color: var(--text-light);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        /* Results */
        #result-container {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            animation: fadeIn 0.5s ease-out;
            border: 2px solid #dee2e6;
        }

        #result-container h2 {
            color: var(--primary-dark);
            padding-bottom: 15px;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 3px solid var(--primary);
        }

        #result-container p {
            margin: 12px 0;
            line-height: 1.7;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-light);
        }

        #result-container strong {
            color: var(--primary-dark);
            font-weight: 700;
            display: inline-block;
            min-width: 200px;
        }

        .hidden {
            display: none !important;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-message {
            color: #c62828;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #c62828;
        }

        .error-message p {
            margin: 5px 0;
            line-height: 1.6;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
        }

        .error-message p:first-child {
            font-weight: 600;
            font-size: 1.05rem;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .logo {
                width: 60px;
                height: 60px;
            }

            .content {
                padding: 20px;
            }

            #result-container strong {
                min-width: auto;
                display: block;
                margin-bottom: 5px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="header">
            <div class="logo-container">
                <div class="logo-container-inner" data-logo-fallback>
                    <img src="assets/logo.png" alt="Pharmalens Logo" class="logo"
                        onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-pills\' style=\'font-size: 60px; color: #ffa500;\'></i>';">
                </div>
            </div>
            <h1><i class="fas fa-pills"></i> Pharmalens Kenya</h1>
            <p>Smart Pill Identifier powered by AI</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab-button active" data-tab="upload-tab">
                    <i class="fas fa-camera"></i> Take Photo
                </button>
                <button class="tab-button" data-tab="manual-tab">
                    <i class="fas fa-keyboard"></i> Manual Entry
                </button>
            </div>

            <!-- Photo Upload Tab -->
            <div id="upload-tab" class="tab-content active">
                <div id="file-upload-area" class="file-upload">
                    <i class="fas fa-camera"></i>
                    <p>Click to upload pill photo</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">

                <div id="image-preview" class="image-preview-container hidden">
                    <img id="preview-img" alt="Pill preview">
                    <div>
                        <button class="change-image-btn" id="change-image-btn">
                            <i class="fas fa-sync-alt"></i> Change Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Tab -->
            <div id="manual-tab" class="tab-content">
                <div class="input-group">
                    <label for="imprint">Imprint/Text on Pill:</label>
                    <input type="text" id="imprint" placeholder="e.g., L544, TYLENOL">
                </div>

                <div class="input-group">
                    <label for="color">Color:</label>
                    <select id="color">
                        <option value="">Select Color</option>
                        <option value="white">White</option>
                        <option value="yellow">Yellow</option>
                        <option value="blue">Blue</option>
                        <option value="red">Red</option>
                        <option value="green">Green</option>
                        <option value="orange">Orange</option>
                        <option value="pink">Pink</option>
                        <option value="brown">Brown</option>
                        <option value="purple">Purple</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="shape">Shape:</label>
                    <select id="shape">
                        <option value="">Select Shape</option>
                        <option value="round">Round</option>
                        <option value="oval">Oval</option>
                        <option value="capsule">Capsule</option>
                        <option value="square">Square</option>
                        <option value="rectangle">Rectangle</option>
                        <option value="diamond">Diamond</option>
                        <option value="pentagon">Pentagon</option>
                        <option value="hexagon">Hexagon</option>
                    </select>
                </div>
            </div>

            <button class="btn-identify" id="submitBtn">
                <i class="fas fa-search"></i> Identify Medication
            </button>

            <div id="loading">
                <div class="loading-animation">
                    <div class="pill-container">
                        <div class="pill" id="pill">
                            <div class="pill-left"></div>
                            <div class="pill-right"></div>
                        </div>
                        <div class="scan-line"></div>
                        <div class="scan-particles">
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                        </div>
                    </div>
                </div>
                <div class="loading-status" id="loading-status">Processing image...</div>
                <div class="loading-substatus" id="loading-substatus">Preparing medication photo for analysis</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loading-progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <div id="result-container"></div>
        </div>
    </div>

    <script type="module">
        // State variables
        let base64Image = null;
        let currentTab = 'upload-tab';
        let uploadCount = 0;
        let manualSearchCount = 0;

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('file-upload-area');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const changeImageBtn = document.getElementById('change-image-btn');
        const submitBtn = document.getElementById('submitBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');

        // Empty medications object - now using backend API for all medication data
        const mockMedications = { upload: [], manual: {} };

        // Function to get result from backend API
        async function getMedicationResult(isUpload) {
            try {
                const requestData = {};
                
                if (isUpload && base64Image) {
                    // For image upload
                    requestData.imageBase64 = base64Image.split(',')[1]; // Remove the data URL prefix if present
                } else if (!isUpload) {
                    // For manual search
                    requestData.imprint = document.getElementById('imprint')?.value.trim().toLowerCase() || '';
                    requestData.color = document.getElementById('color')?.value.toLowerCase() || '';
                    requestData.shape = document.getElementById('shape')?.value.toLowerCase() || '';
                    
                    // Check if at least one field is provided
                    if (!requestData.imprint && !requestData.color && !requestData.shape) {
                        throw new Error('Please provide at least one search criteria');
                    }
                } else {
                    throw new Error('No image or search criteria provided');
                }
                
                console.log('Sending request with data:', requestData);
                
                const response = await fetch('https://us-central1-pharmalensmedix.cloudfunctions.net/identifyMedication', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error || 'Failed to identify medication');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error identifying medication:', error);
                return {
                    success: false,
                    error: 'Failed to identify medication. Please check your connection and try again.'
                };
            }
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                if (!tabId) return;

                // Update buttons
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }

                // Update current tab
                currentTab = tabId;
            });
        });

        // File upload handling
        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                base64Image = event.target.result;
                previewImg.src = base64Image;
                fileUploadArea.classList.add('hidden');
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        // Change image
        changeImageBtn.addEventListener('click', () => {
            base64Image = null;
            fileInput.value = '';
            imagePreview.classList.add('hidden');
            fileUploadArea.classList.remove('hidden');
            resultContainer.innerHTML = '';
        });

        // Loading stages
        const loadingStages = [
            { status: "Processing image...", substatus: "Preparing medication photo for analysis", progress: 15 },
            { status: "Identifying medication...", substatus: "Analyzing pill characteristics and imprints", progress: 35 },
            { status: "Retrieving drug information...", substatus: "Accessing medication database", progress: 55 },
            { status: "Analyzing side effects...", substatus: "Compiling safety information", progress: 75 },
            { status: "Finalizing results...", substatus: "Preparing comprehensive medication report", progress: 95 }
        ];

        function updateLoadingStage(stageIndex) {
            if (stageIndex >= loadingStages.length) return;
            const stage = loadingStages[stageIndex];
            document.getElementById('loading-status').textContent = stage.status;
            document.getElementById('loading-substatus').textContent = stage.substatus;
            document.getElementById('loading-progress-bar').style.width = stage.progress + '%';
        }

        // Pill breaking animation
        function breakPill() {
            const pill = document.getElementById('pill');
            pill.classList.add('breaking');

            setTimeout(() => {
                pill.classList.add('broken');
            }, 300);
        }

        function resetPill() {
            const pill = document.getElementById('pill');
            pill.classList.remove('breaking', 'broken');
        }

        // Display result function
        function displayResult(result) {
            const resultContainer = document.getElementById('result-container');
            
            if (result.success && result.data) {
                const data = result.data;
                resultContainer.innerHTML = `
                    <div class="result-content">
                        <h2><i class="fas fa-pills"></i> ${data.medicationName || 'Medication Details'}</h2>
                        <div class="result-section">
                            <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                            <p><strong>Primary Use:</strong> ${data.primaryUse || 'N/A'}</p>
                            <p><strong>Active Ingredients:</strong> ${data.activeIngredients || 'N/A'}</p>
                            <p><strong>Age Group:</strong> ${data.ageGroup || 'N/A'}</p>
                        </div>
                        
                        <div class="result-section">
                            <h3><i class="fas fa-stethoscope"></i> Medical Information</h3>
                            <p><strong>Treatable Symptoms:</strong> ${data.treatableSymptoms || 'N/A'}</p>
                            <p><strong>Contraindicated Groups:</strong> ${data.contraindicatedGroups || 'N/A'}</p>
                            <p><strong>Dosage Duration:</strong> ${data.dosageDuration || 'N/A'}</p>
                        </div>
                        
                        <div class="result-section">
                            <h3><i class="fas fa-exclamation-triangle"></i> Warnings & Side Effects</h3>
                            <p><strong>Common Side Effects:</strong> ${data.commonSideEffects || 'N/A'}</p>
                            <p><strong>Severe Reactions:</strong> ${data.severeReactions || 'N/A'}</p>
                            <p><strong>Do Not Mix With:</strong> ${data.doNotMixWith || 'N/A'}</p>
                            <p><strong>Medication Interactions:</strong> ${data.medicationInteractions || 'N/A'}</p>
                        </div>
                        
                        <div class="result-section">
                            <h3><i class="fas fa-info-circle"></i> Additional Information</h3>
                            <p><strong>Approximate Cost (KSH):</strong> ${data.approximateCostKSH || 'N/A'}</p>
                            <p><strong>Alternative Medications:</strong> ${data.alternativeMedications || 'N/A'}</p>
                        </div>
                        
                        <div class="disclaimer-section">
                            <p class="disclaimer">${data.disclaimer || 'Please consult a healthcare professional before taking any medication.'}</p>
                            <p class="warning">${data.counterfeitWarning || 'Always purchase medications from licensed pharmacies.'}</p>
                        </div>
                    </div>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${result.error || 'Failed to identify medication. Please try again.'}</p>
                    </div>
                `;
            }
            
            resultContainer.style.display = 'block';
        }

        // Validate form inputs
        function validateForm() {
            if (currentTab === 'upload-tab') {
                return Boolean(base64Image);
            }
            
            if (currentTab === 'manual-tab') {
                const imprint = document.getElementById('imprint')?.value.trim() || '';
                const color = document.getElementById('color')?.value || '';
                const shape = document.getElementById('shape')?.value || '';
                return Boolean(imprint || color || shape);
            }
            
            return false;
        }

        // Update UI state
        function setLoadingState(isLoading) {
            const submitBtn = document.getElementById('submitBtn');
            const resultContainer = document.getElementById('result-container');
            const loading = document.getElementById('loading');
            
            if (loading) {
                loading.style.display = isLoading ? 'block' : 'none';
            }
            
            if (resultContainer) {
                resultContainer.style.display = 'none';
            }
            
            if (submitBtn) {
                submitBtn.disabled = isLoading;
                submitBtn.innerHTML = isLoading 
                    ? '<i class="fas fa-spinner fa-spin"></i> Identifying...' 
                    : '<i class="fas fa-search"></i> Identify Medication';
            }
        }

        // Main identify function
        async function identifyPill() {
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                const isValid = validateForm();
                if (!isValid) {
                    alert(currentTab === 'upload-tab' 
                        ? "Please upload a photo first." 
                        : "Please fill in at least one field.");
                    return;
                }
                
                setLoadingState(true);

                // Disable the submit button to prevent multiple clicks
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Identifying...';
                }
                
                // Hide result and show loading
                if (resultContainer) resultContainer.style.display = 'none';
                if (loading) loading.style.display = 'block';
                
                const loadingMessage = document.getElementById('loading-message');
                const progressBar = document.getElementById('loading-progress-bar');
                const loadingStatus = document.getElementById('loading-status');
                
                if (loadingMessage) loadingMessage.textContent = 'Analyzing medication...';
                if (progressBar) progressBar.style.width = '0%';
                if (loadingStatus) loadingStatus.textContent = 'Initializing analysis...';

                // Simulate progress for better UX
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress > 80) clearInterval(progressInterval);
                    document.getElementById('loading-progress-bar').style.width = `${Math.min(progress, 80)}%`;
                }, 300);

                // Simulate analysis stages
                const stages = [
                    currentTab === 'upload-tab' ? 'Processing image...' : 'Processing request...',
                    'Enhancing quality...',
                    'Analyzing features...',
                    'Matching with database...',
                    'Verifying results...'
                ];
                
                let currentStage = 0;
                const stageInterval = setInterval(() => {
                    if (currentStage < stages.length) {
                        document.getElementById('loading-status').textContent = stages[currentStage];
                        currentStage++;
                    }
                }, 1200);

                // Call the backend API
                const result = await getMedicationResult(currentTab === 'upload-tab');
                
                // Clear intervals and update UI
                clearInterval(stageInterval);
                clearInterval(progressInterval);
                document.getElementById('loading-progress-bar').style.width = '100%';
                document.getElementById('loading-status').textContent = 'Analysis complete!';
                
                // Display the result
                displayResult(result);
                
            } catch (error) {
                console.error('Error identifying pill:', error);
                displayResult({ success: false, error: 'An error occurred while identifying the medication.' });
            } finally {
                if (loading) loading.style.display = 'none';
                const submitBtn = document.getElementById('submitBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-search"></i> Identify Medication';
                }
            }
        }

        // Attach to button
        submitBtn.addEventListener('click', identifyPill);
    </script>
</body>

</html>